---
layout: post
title: PHP调用GPG命令pgp加密文件不执行
description: PHP调用gpg加密命令不执行，exec返回值是2
category: php
tags: [php,gpg,PGP加密]
---
###PHP调用gpg加密命令不执行###
<p>PHP调用gpg加密命令不执行，在命令行下执行。</p>

	php:
		exec('gpg --recipient zhangwenyou@cnzxsoft.com --output /tmp/test.en.txt --encrypt /tmp/test.txt', $output, $resultval);
	

<p>$resultval返回值为2，$output为空！不能加密文件。</p>

	shell:
		gpg --recipient zhangwenyou@cnzxsoft.com --output /tmp/test.en.txt --encrypt /tmp/test.txt

<p>可以执行。</p>

<p>可能原因：1、php调用时找不到公钥存储的位置。2、php以是非root权限运行的，不能成功执行gpg命令。</p>

<p>我用的解决办法（不一定是对的或最好的解决方式，但是暂时解决了问题）：</p>

####方法如下：###
<p>1、新建C程序文件 gpgen.c ，代码如下：</p>

	#include <stdio.h>
	#include <stdlib.h>
	#include <sys/types.h>
	#include <unistd.h>
	int main(int argc, char* argv[])
	{
        uid_t uid, euid;
        uid = getuid();
        euid = geteuid();
        if(setreuid(euid, uid))]
                perror("setreuid");
        
        char s[256] = {0};
        sprintf(s,"gpg --recipient %s --output %s --encrypt %s", argv[1], argv[2], argv[3]); 
        
        system(s);
        
        //system("whoami > /tmp/who.txt"); //查看一下用户是不是root
        
        return 0;
	}

<p>2、把上面的文件生成可执行程序：</p>

	shell:
	gcc -o gpgen -Wall gpgen.c
	chmod u+s gpgen

<p>3、再用PHP调用这个生成的可执行程序，代替直接调用gpg命令：</p>
	
	php:
		putenv("GNUPGHOME=/root/.gnupg"); //这个也要加上，指定GNUPGHOME，要不gpg还是查不到公钥所在的位置。
        exec("./gpgen zhangwenyou@cnzxsoft.com /tmp/test.en.txt /tmp/test.txt", $output, $resultval);

<p>这样就可以解决问题了。</p>
